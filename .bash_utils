# ==============================
# Docker Apps Manager â€” commande : da
# ==============================

# --- Base path : rÃ©pertoire "docker-apps/" (lÃ  oÃ¹ ce fichier est sourcÃ©) ---
if [ -z "$CUSTOM_DOCKER_CLUSTER_BASE_PATH" ]; then
    CUSTOM_DOCKER_CLUSTER_BASE_PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    export CUSTOM_DOCKER_CLUSTER_BASE_PATH
fi

# --- Options par dÃ©faut ---
DOCKER_COMPOSE_UP_DEFAULT_OPTS=(--detach)
DOCKER_COMPOSE_DOWN_DEFAULT_OPTS=(--timeout 10)
DOCKER_COMPOSE_LOGS_DEFAULT_OPTS=(--follow --tail=50)

# ==============================
# Helpers internes
# ==============================

__da_list_clusters() {
    local base="$CUSTOM_DOCKER_CLUSTER_BASE_PATH"
    for d in "$base"/*/; do
        [ -d "$d" ] && basename "$d"
    done
}

__da_compose_file() {
    local name="$1"
    echo "$CUSTOM_DOCKER_CLUSTER_BASE_PATH/$name/config/docker-compose.yaml"
}

__da_lock_file() {
    local name="$1"
    echo "$CUSTOM_DOCKER_CLUSTER_BASE_PATH/$name/.lock"
}

__da_run_hook() {
    local script="$1"
    local label="$2"
    if [ -f "$script" ]; then
        if [ -x "$script" ]; then
            echo "â–¶ï¸  ExÃ©cution de $label..."
            bash "$script" || { echo "âŒ Ã‰chec de $label"; return 1; }
        else
            echo "âš ï¸  $label trouvÃ© mais non exÃ©cutable (chmod +x ?), ignorÃ©."
        fi
    fi
}

__da_require_cluster() {
    local name="$1"
    local dir="$CUSTOM_DOCKER_CLUSTER_BASE_PATH/$name"
    local compose_file="$(__da_compose_file "$name")"

    [ -n "$name" ]         || { echo "âŒ Nom de cluster manquant."; return 1; }
    [ -d "$dir" ]          || { echo "âŒ Cluster introuvable : $name"; return 1; }
    [ -f "$compose_file" ] || { echo "âŒ docker-compose.yaml manquant : $compose_file"; return 1; }
}

# ==============================
# Sous-commandes
# ==============================

__da_up() {
    local name="$1"; shift
    __da_require_cluster "$name" || return 1

    local config_dir="$CUSTOM_DOCKER_CLUSTER_BASE_PATH/$name/config"
    local compose_file="$(__da_compose_file "$name")"
    local lock="$(__da_lock_file "$name")"

    if [ -f "$lock" ]; then
        echo "ğŸ”’ Cluster dÃ©jÃ  actif : $name"
        sed 's/^/   /' "$lock"
        return 1
    fi

    __da_run_hook "$config_dir/pre-up.sh" "pre-up.sh" || return 1

    echo "ğŸš€ DÃ©marrage du cluster : $name"
    docker compose -f "$compose_file" up "${DOCKER_COMPOSE_UP_DEFAULT_OPTS[@]}" "$@" || {
        echo "âŒ Ã‰chec du dÃ©marrage de $name"
        return 1
    }

    { echo "PID=$$"; echo "STARTED_AT=$(date '+%Y-%m-%d %H:%M:%S')"; } > "$lock"
    echo "ğŸ”’ Lock crÃ©Ã© : $lock"

    __da_run_hook "$config_dir/post-up.sh" "post-up.sh"
    echo "âœ… Cluster dÃ©marrÃ© : $name"
}

__da_down() {
    local name="$1"; shift
    __da_require_cluster "$name" || return 1

    local config_dir="$CUSTOM_DOCKER_CLUSTER_BASE_PATH/$name/config"
    local compose_file="$(__da_compose_file "$name")"
    local lock="$(__da_lock_file "$name")"

    if [ ! -f "$lock" ]; then
        echo "âš ï¸  Aucun lock trouvÃ© pour $name â€” cluster peut-Ãªtre dÃ©jÃ  arrÃªtÃ©."
        echo "   Tentative d'arrÃªt quand mÃªme..."
    fi

    __da_run_hook "$config_dir/pre-down.sh" "pre-down.sh" || return 1

    echo "ğŸ›‘ ArrÃªt du cluster : $name"
    docker compose -f "$compose_file" down "${DOCKER_COMPOSE_DOWN_DEFAULT_OPTS[@]}" "$@" || {
        echo "âŒ Ã‰chec de l'arrÃªt de $name"
        return 1
    }

    if [ -f "$lock" ]; then
        rm -f "$lock"
        echo "ğŸ—‘ï¸  Lock supprimÃ© : $lock"
    fi

    __da_run_hook "$config_dir/post-down.sh" "post-down.sh"
    echo "âœ… Cluster arrÃªtÃ© : $name"
}

__da_restart() {
    local name="$1"; shift
    __da_require_cluster "$name" || return 1
    __da_down "$name" && __da_up "$name" "$@"
}

__da_status() {
    echo "ğŸ“Š Statut des clusters Docker"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    local clusters=( $(__da_list_clusters) )

    if [ ${#clusters[@]} -eq 0 ]; then
        echo "â„¹ï¸  Aucun cluster trouvÃ© dans $CUSTOM_DOCKER_CLUSTER_BASE_PATH"
        return
    fi

    for name in "${clusters[@]}"; do
        local lock="$(__da_lock_file "$name")"
        local compose_file="$(__da_compose_file "$name")"

        local compose_warn=""
        [ ! -f "$compose_file" ] && compose_warn=" âš ï¸  (docker-compose.yaml manquant)"

        if [ -f "$lock" ]; then
            local started_at pid
            started_at=$(grep '^STARTED_AT=' "$lock" | cut -d= -f2-)
            pid=$(grep '^PID=' "$lock" | cut -d= -f2)
            echo "  ğŸŸ¢ $name â€” Actif$compose_warn"
            echo "     â”œ STARTED_AT : $started_at"
            echo "     â”” PID        : $pid"
        else
            echo "  ğŸ”´ $name â€” ArrÃªtÃ©$compose_warn"
        fi
    done
}

__da_logs() {
    local name="$1"; shift
    __da_require_cluster "$name" || return 1
    docker compose -f "$(__da_compose_file "$name")" logs "${DOCKER_COMPOSE_LOGS_DEFAULT_OPTS[@]}" "$@"
}

__da_build() {
    local name="$1"; shift
    __da_require_cluster "$name" || return 1
    echo "ğŸ”¨ Build des images du cluster : $name"
    docker compose -f "$(__da_compose_file "$name")" build "$@"
}

__da_help() {
    cat <<EOF
Usage : da <commande> [cluster] [options...]

Commandes disponibles :
  up      <cluster>   Monter un cluster (exÃ©cute pre-up.sh / post-up.sh si prÃ©sents)
  down    <cluster>   DÃ©monter un cluster (exÃ©cute pre-down.sh / post-down.sh si prÃ©sents)
  restart <cluster>   RedÃ©marrer un cluster (down puis up)
  build   <cluster>   Construire les images custom d'un cluster
  logs    <cluster>   Afficher les logs d'un cluster (dÃ©faut : --follow --tail=50)
  status              Afficher le statut de tous les clusters (avec dÃ©tails des locks)
  help                Afficher cette aide

Clusters disponibles :
$(for c in $(__da_list_clusters); do echo "  - $c"; done)

RÃ©pertoire de base : $CUSTOM_DOCKER_CLUSTER_BASE_PATH
EOF
}

# ==============================
# MÃ©ta-commande principale : da
# ==============================

da() {
    local cmd="$1"; shift

    case "$cmd" in
        up)      __da_up      "$@" ;;
        down)    __da_down    "$@" ;;
        restart) __da_restart "$@" ;;
        status)  __da_status  "$@" ;;
        logs)    __da_logs    "$@" ;;
        build)   __da_build   "$@" ;;
        help|"") __da_help       ;;
        *)
            echo "âŒ Commande inconnue : '$cmd'"
            echo "   Tapez 'da help' pour la liste des commandes."
            return 1
            ;;
    esac
}

# ==============================
# AutocomplÃ©tion Bash
# ==============================

# Sous-commandes exposÃ©es par 'da'
__da_subcommands="up down restart build logs status help"

# Sous-commandes qui attendent un nom de cluster en 2e argument
__da_cluster_subcommands="up down restart build logs"

__da_complete() {
    local cur="${COMP_WORDS[COMP_CWORD]}"

    case "$COMP_CWORD" in
        1)
            # ComplÃ©tion des sous-commandes
            COMPREPLY=( $(compgen -W "$__da_subcommands" -- "$cur") )
            ;;
        2)
            # ComplÃ©tion du nom de cluster pour les sous-commandes qui en ont besoin
            local subcmd="${COMP_WORDS[1]}"
            if [[ " $__da_cluster_subcommands " == *" $subcmd "* ]]; then
                COMPREPLY=( $(compgen -W "$(__da_list_clusters)" -- "$cur") )
            fi
            ;;
    esac
}

complete -F __da_complete da
